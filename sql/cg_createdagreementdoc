USE [HLEMSBusiness]
GO
/****** Object:  StoredProcedure [dbo].[CG_CreateDAgreementDoc]    Script Date: 2018/5/24 7:22:12 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--dbo.CG_CreateDPurchaseDoc 'e0063e5e-fe02-4462-b0a6-5f1a8fbea7dd'
--dbo.CG_CreateDQuotationDoc 'e0063e5e-fe02-4462-b0a6-5f1a8fbea7dd'
----2011-12-13
----功能：根据旧系统导数据单据生成对应的合同单据
----白兵
--EXEC [CG_CreateDAgreementDoc] 'e0063e5e-fe02-4462-b0a6-5f1a8fbea7dd'
ALTER PROCEDURE [dbo].[CG_CreateDAgreementDoc]
@CG_MaterialInMainD_ID NVARCHAR(50)
	
AS
BEGIN

DECLARE @DocDate DATETIME
DECLARE @DDocDate DATETIME
DECLARE @CG_CompanyInfo_ID NVARCHAR(50)
DECLARE @CG_AgreementMain_ID NVARCHAR(50)  ----自动生成的请购单ID
DECLARE @AgreementDocNum NVARCHAR(50)
DECLARE @Curline CURSOR
DECLARE @CG_MaterialInSubD_ID NVARCHAR(50)             ----子表ID
DECLARE @UnitPrice DECIMAL(18,6)  
DECLARE @Qty DECIMAL(18,4)
DECLARE @CG_PurchaseSub_ID NVARCHAR(50)
DECLARE @CG_QuotationSub_ID NVARCHAR(50)



SELECT  @DocDate=DocDate,@DDocDate=InDate,@CG_CompanyInfo_ID=CG_CompanyInfo_ID 
FROM CG_MaterialInMainD
WHERE ID=@CG_MaterialInMainD_ID

SET @CG_AgreementMain_ID=NEWID()

SET @AgreementDocNum=(SELECT dbo.nextcode((SELECT MAX(AgreementNum) FROM CG_AgreementMain  
WHERE AgreementNum LIKE 'DHT%'),'DHT'+right(year(@DocDate),2)+right(100+month(@DocDate),2),3))


IF NOT EXISTS(SELECT 1 FROM CG_AgreementMain 
				WHERE Remark=@CG_MaterialInMainD_ID)
	BEGIN
		INSERT INTO [CG_AgreementMain]
           ([ID]
           ,[AgreementNum]
           ,[AgreementType]
           ,[Docdate]
           ,[AgreementDate]
           ,[AgreementLocation]
           ,[CG_BusinessPartner_ID]
           ,[CG_CompanyInfo_ID]
           ,[QCStanderd]
           ,[QCPeriod]
           ,[PackageStanderd]
           ,[TransportCost]
           ,[CheckStanderd]
           ,[PaymentType_ID]
           ,[Settlement]
           ,[TaxRate]
           ,[AdjustPrice]
           ,[Status]
           ,[Remark])
 
    VALUES
     (@CG_AgreementMain_ID,@AgreementDocNum,'1',
     @DocDate,@DDocDate,'1','b897e333-4c80-4ed2-82b7-f4a8c31fb7c6',@CG_CompanyInfo_ID,
     '符合需方制定的相关标准，能够满足需方的生产需要。','半年',
     '按厂家要求',1,'根据第二条的要求进行验收',
     '1','2','0.00',0,'20',@CG_MaterialInMainD_ID)
     
     IF @@ROWCOUNT<>1 OR @@error<>0
					BEGIN
						ROLLBACK TRAN
						RAISERROR('根据ERP旧系统导入数据生成合同主表出错!',16,1) WITH SETERROR
						RETURN
					END
     
		SET @Curline = CURSOR for
		SELECT ID
		FROM CG_MaterialInSubD
		WHERE (CG_MaterialInMainD_ID = @CG_MaterialInMainD_ID)

		OPEN @Curline

		WHILE (1 = 1)
		BEGIN
			FETCH NEXT FROM  @Curline INTO @CG_MaterialInSubD_ID 

			IF (@@FETCH_STATUS<>0) BREAK
			
			SELECT @Qty=InQty,@UnitPrice=UnitPrice
			FROM CG_MaterialInSubD
			WHERE (ID = @CG_MaterialInSubD_ID )
			
			SELECT  @CG_PurchaseSub_ID=ID
			FROM CG_PurchaseSub
			WHERE Remark=@CG_MaterialInSubD_ID
			
			SELECT @CG_QuotationSub_ID=ID
			FROM CG_QuotationSub
			WHERE Remark=@CG_MaterialInSubD_ID
			
			INSERT INTO [CG_AgreementSub]
           ([ID]
           ,[CG_AgreementMain_ID]
           ,[CG_PurchaseSub_ID]
           ,[CG_QuotationSub_ID]
           ,[Number]
           ,[InQty]
           ,[LackInQty]
           ,[FIBillAmount]
           ,[FIBillLackAmount]
           ,[UnitPrice]
           ,[TotalMoney]
           ,[UnitPriceFloatReason]
           ,[Status]
           ,[Remark])
    
     VALUES
        (NEWID(),@CG_AgreementMain_ID,@CG_PurchaseSub_ID,@CG_QuotationSub_ID,@Qty,0,@Qty,
		@Qty,0,@UnitPrice,@Qty*@UnitPrice,NULL,'10',@CG_MaterialInSubD_ID)
          
          
           IF @@ROWCOUNT<>1 OR @@error<>0
					BEGIN
						ROLLBACK TRAN
						RAISERROR('根据ERP旧系统导入数据生成合同单子表出错!',16,1) WITH SETERROR
						RETURN
					END

			
		END


CLOSE @Curline
DEALLOCATE @Curline
     
    
     
     EXEC CG_AgreementMainDAudit @CG_AgreementMain_ID
	END



if (@@error<>0)
			begin
				
				raiserror('生成合同信息出错！',16,1)
				return
			end	
		else
		
			begin
				select 1 as CheckResult,'成功生成采购合同信息!'+@AgreementDocNum as CheckMsg
				Return 
			end

END
