* ssyg(尚尚优购)
** TODO todo
*** DONE 修改前端的剩余数量 
    CLOSED: [2020-09-29 二 09:30]
		$supper_goods_list = M('lionfish_comshop_good_common')->field('goods_id')->where( array('supply_id' =>$supper_info['id'] ) )->select();
       
    
		$quan_list = M()->query("select * from ".C('DB_PREFIX')."lionfish_comshop_coupon where 1 {$where} order by displayorder desc ,id asc limit 100 ");
*** 团购页面能够插入信息(用户名，手机) + 地址信息
    购买类型 dan,pindan, pintuan,soitaire(纸片)，integral (积分)，另一种是(activity)活动，是默认情况。
    buy_type == "dan" || buy_type == "pindan"
  - 单独购买"dan"
  - 拼单 pingdan
  - 拼团 "pintuan"
  - 拼的模式有两种，在 config 表中  pintuan_model_buy 
    
   类型只有四种么，数据库中 'pintuan', 'normal', 'lottery' ,'integral','virtual','spike' (废弃)

    
   配送类型 
   dispatching == 'express'
  - `delivery` enum('express','pickup','tuanz_send','localtown_delivery') DEFAULT 'express' COMMENT '配送类型',
  - //'express'  快递, 'pickup'  自提, 'tuanz_send'  团长配送,localtown_delivery')   tuan_send_address 
  
   订单基本要改
   address_id: 要变成我的 4
   delivery : 收获类型
   pick_up_id
   shipping_address
   shipping_city_id: "1520"
  shipping_country_id
  ziti_mobile: "13013917294"  要改成我的
  ziti_name: "Adam"


拼团对照数据
#+begin_example
address_id: "4"
comment: ""
date_added: 1601349553
delivery: "express"
expected_delivery_time: ""
from_type: "wepro"
goodss: [{goods_id: "5", store_id: 1, name: "金银花茶250g双花茶封丘金银花散装非野生特级胖大海菊花茶无清火", model: "", is_pin: 1,…}]
is_free_shipping_fare: 0
is_localtown_free_shipping_fare: 0
localtown_free_shipping_fare: 0
man_total_free: 0
member_id: "16"
name: "阿明"
note_content: ""
order_goods_total_money: 0.01
order_num_alias: "202009291649101509"
packing_fare: 0
payment_method: null
pick_up_id: "1"
reduce_money: 0
score_for_money: 0
shipping_address: "江阴市政府南"
shipping_city_id: "1520"
shipping_country_id: "1527"
shipping_fare: 0
shipping_method: 0
shipping_name: "吴明"
shipping_province_id: "1507"
shipping_stree_id: 0
shipping_tel: "18360812281"
store_id: 0
telephone: "18360812281"
total: 0.01
totals: [{code: "sub_total", title: "商品价格", text: "￥0.01", value: 0.01},…]
type: "pintuan"
use_score: 0
user_agent: "Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_1 like Mac OS X) AppleWebKit/603.1.3 (KHTML, like Gecko) Version/10.0 Mobile/14E304 Safari/602.1 wechatdevtools/1.02.1910121 MicroMessenger/7.0.4 Language/zh_CN webview/"
voucher_credit: 0
voucher_id: 0
ziti_mobile: null
ziti_name: null
#+end_example
**** lionfish_comshop/pages/order/placeOrder 团购页面
**** lionfish_comshop/pages/order/placeOrder 拼团页面
     

** 前端
*** 域名 https://lyq.iguohui.cn
*** 链接处理
    
    http://localhost:8002/wxapp.php?i=undefined&t=undefined&v=undefined&from=wxapp&c=entry&a=wxapp&do=index&m=lionfish_comshop&sign=e894c21a1e32285240d553b9d42cd798&controller=goods.get_goods_detail&token=f3fd1304f10a6a38a3a98e82e34fa085&id=3&community_id=1
    Array ( [c] => [a] => index [sign] => 403526a19239cb1eb63a53cc73a8873f )
    http://localhost:8002/wxapp.php?i=undefined&t=undefined&v=undefined&from=wxapp&c=entry&a=wxapp&do=user&&m=lionfish_comshop&sign=32391f2735c8e6f08d2f02a7c4fbf7ca
    
    wxapp.php 会解析成 Array ( [c] =>CONTROLLER [0] [a]=> CONTROLLER[1] [sign] => 403526a19239cb1eb63a53cc73a8873f {ARGNAME=VALUE})
  
  ULR 变为这种解析方式 http://localhost:8002/seller.php?c=goods&a=index
  
*** 提交订单页面，团购自己选地址
    lionfish_comshop/pages/goods/goodsDetail
    lionfish_comshop/pages/order/placeOrder
    
    lionfish_comshop/pages/order/placeOrder
    
    ssyg_front/lionfish_comshop/pages/goods/goodsDetail.js
    订单有购买类型
    let buy_type = this.data.buy_type || '';
    
    integral 积分
    community 团购
http://localhost:8002/wxapp.php?i=undefined&t=undefined&v=undefined&from=wxapp&c=entry&a=wxapp&do=user&&m=lionfish_comshop&sign=9b5d6973ff035a7cbf4895da16ffa739

RETURN_CODE: "J"
RETURN_MSG: "J"
code: 1
has_yupay: 0
is_go_orderlist: 1
is_spike: 0
order_all_id: "83"
order_id: "47"
text: "错误"

    这里是商户数据
    let room_id = options.room_id || '';
    let buy_type = options.type || '';
**** 提交团购订单 
      //wumingtest,这里开始提交订单
      app.util.request({
        url: 'entry/wxapp/user',
        data: {
          controller: 'car.sub_order',
          token: token,
          pay_method: 'wxpay',
          buy_type,
          pick_up_id,
          dispatching,
          ziti_name: t_ziti_name,
          quan_arr,
          comment,
          ziti_mobile: t_ziti_mobile,
          latitude,
          longitude,
          ck_yupay,
          tuan_send_address,
          lou_meng_hao,
          address_name,
          province_name,
          city_name,
          country_name,
          use_score,
          soli_id,
          note_content,
          expected_delivery_time
        },
        dataType: 'json',
        method: 'POST',
        success: function (res) {

          wx.hideLoading();
          let has_yupay = res.data.has_yupay || 0;
          var order_id = res.data.order_id;
          let h = {};
          console.log('支付日志：', res);
          if (res.data.code == 0) {
            that.changeIndexList();
            if (has_yupay == 1) {
              that.canPay = true;
              if (buy_type == "dan" || buy_type == "pindan" || buy_type == "integral" || buy_type == "soitaire") {
                if (res.data.is_go_orderlist <= 1) {
                  wx.redirectTo({
                    url: '/lionfish_comshop/pages/order/order?id=' + order_id + '&is_show=1'
                  })
                } else {
                  wx.redirectTo({
                    url: '/lionfish_comshop/pages/order/index?is_show=1'
                  })
                }
              } else {
                wx.redirectTo({
                  url: `/lionfish_comshop/moduleA/pin/share?id=${order_id}`
                })
              }
            } else {
              wx.requestPayment({
                "appId": res.data.appId,
                "timeStamp": res.data.timeStamp,
                "nonceStr": res.data.nonceStr,
                "package": res.data.package,
                "signType": res.data.signType,
                "paySign": res.data.paySign,
                'success': function (wxres) {
                  that.canPay = true;
                  if (buy_type == "dan" || buy_type == "pindan" || buy_type == "integral" || buy_type == "soitaire") {
                    if (res.data.is_go_orderlist<=1){
                      wx.redirectTo({
                        url: '/lionfish_comshop/pages/order/order?id=' + order_id + '&is_show=1'
                      })
                    } else {
                      wx.redirectTo({
                        url: '/lionfish_comshop/pages/order/index?is_show=1'
                      })
                    }
                  } else {
                    wx.redirectTo({
                      url: `/lionfish_comshop/moduleA/pin/share?id=${order_id}`
                    })
                  }
                },
                'fail': function (error) {
                  if (res.data.is_go_orderlist <= 1) {
                    wx.redirectTo({
                      url: '/lionfish_comshop/pages/order/order?id=' + order_id + '&?isfail=1'
                    })
                  } else {
                    wx.redirectTo({
                      url: '/lionfish_comshop/pages/order/index?isfail=1'
                    })
                  }
                }
              })
            }
          } else if (res.data.code == 1) {
            that.canPay = true;
            wx.showModal({
              title: '提示',
              content: res.data.RETURN_MSG || '支付失败',
              showCancel: false,
              confirmColor: '#F75451',
              success (ret) {
                if (ret.confirm) {
                  if (res.data.is_go_orderlist <= 1) {
                    wx.redirectTo({
                      url: '/lionfish_comshop/pages/order/order?id=' + order_id + '&isfail=1'
                    })
                  } else {
                    wx.redirectTo({
                      url: '/lionfish_comshop/pages/order/index?is_show=1&?isfail=1'
                    })
                  }
                }
              }
            })
          } else if (res.data.code == 2) {
            that.canPay = true;
            if( res.data.is_forb ==1 ){ h.btnDisable = true; h.btnText="已抢光"; }
            wx.showToast({
              title: res.data.msg,
              icon: "none"
            });
          } else {
            console.log(res);
          }
          that.setData({ btnLoading: false, payBtnLoading:false, ...h })
        },
        fail: function() {
          wx.redirectTo({
            url: '/lionfish_comshop/pages/order/index?is_show=1&?isfail=1'
          })
        }
      })
*** 拼团
    http://localhost:8002/wxapp.php?i=undefined&t=undefined&v=undefined&from=wxapp&c=entry&a=wxapp&do=index&m=lionfish_comshop&sign=ae84c56b208f7b6bfa26c1498af27e4a&controller=group.get_pintuan_list&pageNum=1&gid=undefined&token=efb4e772d472c0441eaca8b5ee2b7894&head_id=1&is_index=1

    delivery_type_tuanz
http://localhost:8002/wxapp.php/group/get_pintuan_list/pageNum/1
*** 页面
**** lionfish_comshop/pages/order/placeOrder 团购页面
**** lionfish_comshop/pages/order/placeOrder 拼团页面
** 后端     
*** 配置
**** 后台账号密码
    - 账号 admin 密码 123
    - 加密密码 MDAwMDAwMDAwMISJet8
    - 表 oscshop_seller
     
**** 说明
***** 我测试的  wumingtest   
***** 我修改的  wumingfix
*** 后台模块
****  index 模块(微信前端)
***** index 测试接口
      http://localhost:8002/index.php/index/index_share
***** goods 商品
****** get_seller_quan (获取优惠券)
       goods/get_seller_quan
***** car.sub_order 先干掉微信付款
**** seller (商家后台)
***** goods
    
*** 表
**** oscshop_lionfish_comshop_area 地区名称
     address_id, member_id, name, telephone, address, address_name, lon_lat, lou_meng_hao, is_default, city_id, country_id, province_id
'4', '16', '吴明', '18360812281', '江阴市政府南', 'HOME', '', '', '1', '1520'[无锡市], '1527'[江阴市], '1507'[江苏省]
**** oscshop_lionfish_comshop_goods 商品表
**** oscshop_lionfish_comshop_good_common 商品详情表，商品表的附加表
**** oscshop_lionfish_comshop_good_commiss (商品规格 )
**** oscshop_lionfish_comshop_supply 供货商信息表
**** oscshop_lionfish_community_head 团长，头子
     -province_id	省
     - city_id 市
     - area_id 县
     - country_id 街道
     - 
# id	member_id	agent_id	level_id	community_name	head_name	head_mobile	groupid	wechat	province_id	city_id	country_id	area_id	address	lon	lat	state	enable	rest	is_default	apptime	is_modify_shipping_method	is_modify_shipping_fare	shipping_fare	addtime
1	1	0	0	阳光国际	Adam	13013917294	0		1507	1520	3624	1527	阳光国际	120.294	31.8953	1	1	0	0	1599895017	0	0	0.00	1599895017

# id, member_id, agent_id, level_id, community_name, head_name, head_mobile, groupid, wechat, province_id, city_id, country_id, area_id, address, lon, lat, state, enable, rest, is_default, apptime, is_modify_shipping_method, is_modify_shipping_fare, shipping_fare, addtime
1, 1, 0, 0, 阳光国际, Adam, 13013917294, 0, , 1507, 1520, 3624, 1527, 阳光国际, 120.294, 31.8953, 1, 1, 0, 0, 1599895017, 0, 0, 0.00, 1599895017

**** oscshop_lionfish_community_head 圈子，团长
**** oscshop_lionfish_comshop_member 公众号用户
     # member_id	openid	we_openid	unionid	share_id	agentid	comsiss_flag	comsiss_state	commission_level_id	comsiss_time	groupid	level_id	isblack	account_money	score	reg_type	username	realname	telephone	avatar	wepro_qrcode	hexiao_qrcod	commiss_qrcode	content	last_login_time	create_time	last_login_ip	pickup_id	full_user_name	is_writecommiss_form	is_share_tj	commiss_formcontent	card_id	card_begin_time	card_end_time	is_comsiss_admin	is_comsiss_audit
1	o1Ev64q-vvgHOBD2-ZZPKmCoq_rY	o1Ev64q-vvgHOBD2-ZZPKmCoq_rY		0	0	0	0	0		0	0	0			weprogram	Adam			https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL7ES2VSzPBylXLzF1w0Gd4hyU6UFV84ZDYvHB5qYJwn7DM4uta9CQIBJdL07QQxA8rQFxeAQa7aA/132	Uploads/image/cache/goods/2020-09-12/30616bb4764512c2c40a2da9a504a674-32x32.jpeg	goods2020-09-14/741db666066d4565e340d472caa17d1e.png			1600909759	1599820392	58.219.56.89	0	QWRhbQ==	0	0		0	0	0	0	0

**** oscshop_lionfish_comshop_address 公众号地址库 
**** oscshop_lionfish_comshop_config 配置信息
**** oscshop_lionfish_comshop_car 客户端购物车表
   `id` int NOT NULL AUTO_INCREMENT COMMENT '自增 id',
   `token` varchar(200) NOT NULL COMMENT '客户端 token,会员身份',
   `community_id` int NOT NULL COMMENT '团长 id',
   `carkey` varchar(255) NOT NULL COMMENT '购物车 key',
   `format_data` text NOT NULL COMMENT '购物车商品参数',
   `modifytime` int DEFAULT '0' COMMENT '加入购物车时间',
 
 # id, token, community_id, carkey, format_data, modifytime
 98, f3fd1304f10a6a38a3a98e82e34fa085, 1, cart.3:1::, a:8:{s:8:"quantity";s:1:"1";s:12:"community_id";s:1:"1";s:8:"goods_id";s:1:"3";s:7:"sku_str";s:0:"";s:8:"buy_type";s:3:"dan";s:7:"soli_id";s:0:"";s:14:"is_just_addcar";i:0;s:9:"singledel";i:1;}, 1601280707
**** oscshop_lionfish_comshop_order 订单
     `type` enum('pintuan','normal','lottery','virtual','bargain','integral','community','ignore') DEFAULT 'normal',
  
     community 团购
  
     `is_pin` tinyint(1) DEFAULT '0' COMMENT '是否拼团，0表示否，1表示是',
     
# order_id	order_num_alias	member_id	store_id	head_id	supply_id	is_vipcard_buy	is_level_buy	type	charge_mobile	is_pin	from_type	perpay_id	name	email	telephone	delivery	shipping_name	address_id	shipping_tel	shipping_city_id	shipping_country_id	shipping_stree_id	shipping_province_id	shipping_address	tuan_send_address	ziti_name	ziti_mobile	shipping_method	dispatchname	shipping_fare	packing_fare	is_free_shipping_fare	fare_shipping_free	man_e_money	old_shipping_fare	changedshipping_fare	shipping_no	shipping_traces	payment_code	score_for_money	transaction_id	comment	remarksaler	note_content	total	old_price	changedtotal	voucher_id	voucher_credit	fullreduction_money	order_status_id	last_refund_order_status_id	is_balance	lottery_win	ip	is_zhuli	is_commission	day_paixu	is_delivery_flag	is_print_suc	is_kdn_print	ip_region	user_agent	date_added	date_modified	pay_time	canceltime	receive_time	finishtime	express_time	express_tuanz_time	shipping_cha_time	is_change_price	is_localtown_free_shipping_fare	localtown_free_shipping_fare	localtown_add_shipping_fare	expected_delivery_time	third_distribution_type
团购
42	202009281650101549	16	0	1	0	0	0	normal		0	wepro	wx281921232182432afbaf5fc3fd44130000	阿明		18345678912	pickup	阿明	0	18345678912	1520	1527	3624	1507	江苏省无锡市江阴市澄江街道阳光国际		Adam	13013917294	0		0.00	0.00	0	0.00	0.00	0.00	0.00	0			0.00					0.0100	0.01	0.00	0	0.00	0.00	5	0	0	0	223.104.145.187	0	0	8	0	1	0		Mozilla/5.0 (Linux; Android 9; MI 6 Build/PKQ1.190118.001; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/78.0.3904.62 XWEB/2690 MMWEBSDK/200601 Mobile Safari/537.36 MMWEBID/5895 MicroMessenger/7.0.16.1700(0x2700103E) Process/appbrand0 WeCh	1601292082	0	0				0		0	0	0	0.00	0.00		

拼团
43	202009291654101535	16	0	0	0	0	0	pintuan		1	wepro	wx29091711267472fba15ac4854bbfe60000	阿明		18360812281	express	吴明	4	18360812281	1520	1527	0	1507	江阴市政府南				0		0.00	0.00	0	0.00	0.00	0.00	0.00	0		weixin	0.00	4200000683202009292414774405				0.0100	0.01	0.00	0	0.00	0.00	2	0	0	0	117.136.66.95	0	0	0	0	1	0		Mozilla/5.0 (Linux; Android 9; MI 6 Build/PKQ1.190118.001; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/78.0.3904.62 XWEB/2690 MMWEBSDK/200601 Mobile Safari/537.36 MMWEBID/5895 MicroMessenger/7.0.16.1700(0x2700103E) Process/appbrand0 WeCh	1601342230	1601342236	1601342236				0		0	0	0	0.00	0.00		
**** oscshop_lionfish_comshop_order_all (订单总表，支付时候使用)
# id, member_id, is_pin, total_money, order_num_alias, order_status_id, transaction_id, out_trade_no, paytime, addtime
51, 16, 1, 0.01, 202009291654101481, 2, 4200000683202009292414774405, 51-1601342231, 1601342236, 1601342230
52, 16, 1, 0.00, 202009291698991019, 3, , , 0, 1601345163
**** oscshop_lionfish_comshop_order_relate 订单总表跟商家订单关联表
**** oscshop_lionfish_comshop_order_status 订单状态
| order_status_id | name                 |
|               1 | 已付款待发货         |
|               2 | 拼团中，已付款       |
|               3 | 待付款               |
|               4 | 已发货，待收货       |
|               5 | 交易已取消           |
|               6 | 已签收               |
|               7 | 已退款               |
|               8 | 退款并送券           |
|               9 | 二等奖，已退款并送券 |
|              10 | 退款失败，请手动退款 |
|              11 | 已完成               |
|              12 | 申请退款中           |
|              13 | 平台介入退款         |
|              14 | 配送中               |
|-----------------+----------------------|
 1,4,6,7,11,14) 
*** 测试 
**** 测试 sql
     http://localhost:8002/wxapp.php/index/test_sql
